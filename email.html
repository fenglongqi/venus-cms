<!DOCTYPE html>
<html lang="zxx">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Taole Auto Build System</title>

    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/vendor-styles.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/email.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="main-wrapper">
      <div class="an-loader-container">
        <img src="img/loader.png" alt="">
      </div>

      <header id="header" class="an-header wow fadeInDown">
      </header> <!-- end .AN-HEADER -->

      <div class="an-notification-content top-full-width">
        <div class="alert alert-danger  js-nofitication-body" role="alert">
          <button type="button" class="close"><span aria-hidden="true">&times;</span></button>
          <strong>警告!</strong> 当前未发现可用的客户端，请先安装并运行客户端.
        </div>
      </div>

      <div class="an-page-content">
        <div id="sidebar" class="an-sidebar-nav js-sidebar-toggle-with-click">
        </div>
        <div class="an-content-body">
          <div class="an-body-topbar wow fadeIn">
            <div class="an-page-title">
              <h2>邮件列表</h2>
              <p>Welcome to use this system
                <a href="#"><i class="icon-marker"></i>杭州</a>
              </p>
            </div>

            <div class="an-daterange-picker">
              <div id="reportrange" class="pull-right">
                <i class="icon-calendar"></i>&nbsp;
                <span></span>
              </div>
            </div> <!-- end AN-DATERANGE-PICKER -->
          </div> <!-- end AN-BODY-TOPBAR -->

          <div class="an-panel-main-info">
            <div class="row an-agent-info-item">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="an-single-component with-shadow" id="script-content">
                            <div class="an-component-header">
                                <h6>打包成功发送邮件列表</h6>
                                
                                <div class="component-header-right">
                                <div>
                                    <span class="script-reload"><i class="icon-loading"></i></span>
                                </div>
                                <div class="an-default-header-right">
                                    <button id="add-success-email" class="an-btn an-btn-icon add-content an-btn-primt" data-type="2" type="button">添加</button>
                                </div>
                                </div>
                            </div>
                            <div class="an-component-body">
                                <div class="an-user-lists messages">
                                <div class="list-title">
                                    <h6 class="basis-40">收件人</h6>
                                    <h6 class="basis-50">邮箱地址</h6>
                                    <h6 class="basis-10">管理</h6>
                                    <h6></h6>
                                </div>
                
                                <div id="success-list" class=" an-lists-body an-customScrollbar">
                                    
                
                
                                </div> <!-- end .AN-LISTS-BODY -->
                                </div>
                            </div> <!-- end .AN-COMPONENT-BODY -->
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="an-single-component with-shadow" id="script-content">
                            <div class="an-component-header">
                                <h6>打包失败发送邮件列表</h6>
                                
                                <div class="component-header-right">
                                <div>
                                    <span class="script-reload"><i class="icon-loading"></i></span>
                                </div>
                                <div class="an-default-header-right">
                                    <button id="add-fail-email" data-type="1" class="an-btn an-btn-icon add-content an-btn-primt " type="button">添加</button>
                                </div>
                                </div>
                            </div>
                            <div class="an-component-body">
                                <div class="an-user-lists messages">
                                <div class="list-title">
                                    <h6 class="basis-40">收件人</h6>
                                    <h6 class="basis-50">邮箱地址</h6>
                                    <h6 class="basis-10">管理</h6>
                                    <h6></h6>
                                </div>
                
                                <div id="fail-list" class=" an-lists-body an-customScrollbar">
                                    <div  class="list-user-single contact-item" data-id="${data[i]._id}">            
                                        <div class="basis-40">
                                            <p>${data[i].user_id}</p>
                                        </div>
                                        <div class="basis-50">
                                            <p>${data[i].email}</p>
                                        </div>
                                        <div class="basis-10">
                                            <button type="button" class="an-btn an-btn-icon small edit-email dropdown-toggle"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="icon-setting"></i>
                                            </button>
                                            <button  class="delete-btn an-btn an-btn-icon small muted danger"><i class="icon-trash"></i></button>   
                                        </div>
                                    </div>
                
                
                                </div> <!-- end .AN-LISTS-BODY -->
                                </div>
                            </div> <!-- end .AN-COMPONENT-BODY -->
                        </div>
                    </div>
                </div>
            </div> <!-- end .ROW -->
          </div> <!-- end .AN-PANEL-MAIN-INFO -->
        </div> <!-- end .AN-PAGE-CONTENT-BODY -->
      </div> <!-- end .AN-PAGE-CONTENT -->



      <footer id="footer" class="an-footer"></footer> <!-- end an-footer -->

      <div class="add-email">
          <h5>添加新的联系人 <span class="add-email-close">X</span></h5>
          <div>邮箱地址<input id="email-address" type="text"></div>
          <div class="add-submit"><button>添加</button></div>
      </div>
      <div class="edit-email-alert">
        <h5>修改联系人<span class="edit-email-close">X</span></h5>
        <div>邮箱地址<input id="edit-email-address" type="text"></div>
        <div>联系人类型<select name="" id="se-type">
            <option value="1">失败</option>
            <option value="2">成功</option>
        </select></div>
        <div class="edit-submit"><button>修改</button></div>
    </div>
    </div> <!-- end .MAIN-WRAPPER -->
    <script src="plugins/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="plugins/bootstrap.min.js" type="text/javascript"></script>

    <!-- 渲染组件 -->
    <script src="components/head.js"></script>
    <script src="components/sidebar.js"></script>
    <script src="components/footer.js"></script>
    <script src="js/render.js"></script>


    <script src="plugins/moment.min.js" type="text/javascript"></script>
    <script src="plugins/daterangepicker.js" type="text/javascript"></script>
    <script src="plugins/wow.min.js" type="text/javascript"></script>
    <script src="plugins/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
    <script src="plugins/selectize.min.js" type="text/javascript"></script>

    <!--  MAIN SCRIPTS START FROM HERE  above scripts from plugin-->
    <script src="js/scripts.js" type="text/javascript"></script>
    <script src="js/cms-api.js" type="text/javascript"></script>
    <script src="js/cms-ui.js" type="text/javascript"></script>

    <script>

        

      if ($('.js-nofitication-body').length > 0) {
          $('.js-nofitication-body').hide();
      }


      function renderEmail(data, $el) {
        $el.html('')
        var str = ''
        for(var i=0,len = data.length;i<len;i++) {
            if(data[i].status == 1) {
                var emailStr =
                    `<div  class="list-user-single contact-item" data-type="${data[i].type}" data-id="${data[i]._id}">           
                        <div class="basis-40">
                            <p>${data[i].user_id}</p>
                        </div>
                        <div class="basis-50">
                            <p>${data[i].email}</p>
                        </div>
                        <div class="basis-10">
                            <button type="button" class="edit-email an-btn an-btn-icon small dropdown-toggle"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="icon-setting"></i>
                            </button>
                            <button  class="delete-btn an-btn an-btn-icon small muted danger"><i class="icon-trash"></i></button>   
                        </div>
                    </div>`
                
                str +=emailStr
            }
        }

        $el.append(str)
        
        
      }

      request_alive_agent(function(success, msg, data) {
        if(!success) {
            alert(msg)
            return false
        }

        $(".agent-total").html(data.count_result.total_agent);
        $(".agent-free").html(data.count_result.alive_agent);
        $(".agent_working").html(data.count_result.working_agent);
      })


      //获取列表信息
      function renderList () {
          //获取失败发送列表
        request_contact_list({type:1},function(success,msg, data) {
            if(!success) {
                alert(msg)
                return false
            }
            renderEmail(data,$('#fail-list'))
        })

        //获取成功发送列表
        request_contact_list({type:2},function(success,msg, data) {
            if(!success) {
                alert(msg)
                return false
            }
            renderEmail(data,$('#success-list'))
        })
      }

      renderList()
      


      //添加新的联系人
      $('.add-content').on('click',function(){
          $('.add-email').show()
          $('.add-email').data('type',$(this).data('type'))
      })
      
      $('.add-email-close').on('click', function() {
        $('.add-email').hide()
      })
      $('.add-submit').on('click', function() {
        console.log($('.add-email').data('type'))
        var email = $('#email-address').val()
        console.log(email)
        if(email) {
            var option = {
                email : email,
                type : $('.add-email').data('type')
            }
            console.log(option)
            $('.add-email').hide()
            request_contact_add(option, function(success, msg, data) {
                if(!success) {
                    alert(msg)
                    return false
                }
                
                renderList()
                $('.add-email').hide()
                
            })
        }
        
      })

        //删除
      $('#fail-list,#success-list').on('click','.delete-btn',function(){
          let _id = $(this).parents('.contact-item').data('id');
          console.log(_id)
          if(confirm('确定要删除吗')) {
              request_contact_delete(_id, function(success,msg,data) {
                  if(success) {
                      alert('删除成功')
                      renderList()
                  }else{
                      alert(msg)
                      return false
                  }
              })
          }
      })

      //更改
      $('#fail-list,#success-list').on('click','.edit-email',function() {
          $('.edit-email-alert').show()
          $('.edit-email-alert').data('type', $(this).parents('.contact-item').data('type'))
          $('.edit-email-alert').data('id',$(this).parents('.contact-item').data('id'))
          $('#se-type').val($('.edit-email-alert').data('type'))
      })
      
      $('.edit-email-close').on('click',function() {
        $('.edit-email-alert').hide()
      })
      $('.edit-submit').on('click', function() {
          var option = ''
        if($('.edit-email-alert').data('type') == $('#se-type').val()){
            option = {
                email: $('#edit-email-address').val(),
                _id: $('.edit-email-alert').data('id')
            }
        }else {
            option = {
                email: $('#edit-email-address').val(),
                _id: $('.edit-email-alert').data('id'),
                type: $('#se-type').val()
            }

        }

        retuqst_contact_edit(option, function(success,msg,data) {
                if(success) {
                    alert('修改成功！')
                    $('.edit-email-alert').hide()
                    renderList()
                }else {
                    alert(msg)
                    return false;
                }
            })       
      })

        
                
    </script>
  </body>
</html>
